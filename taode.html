<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tạo đề toán trắc nghiệm</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    h1, h2 {
      text-align: center;
      color: #4CAF50;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    textarea, input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      display: block;
      width: 180px;
      padding: 12px;
      margin: 20px auto;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #45a049;
    }
    #downloadBtn {
        background-color: #007bff;
    }
    #downloadBtn:hover {
        background-color: #0056b3;
    }
    .question {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      background-color: #f5f5f5;
      border-radius: 4px;
    }
    .question strong {
        color: #333;
    }
    .solution {
      font-style: italic;
      color: #555;
      margin-top: 10px;
      padding-top: 5px;
      border-top: 1px dashed #ccc;
    }
    .answer-table {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
    }
    .answer-table th, .answer-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    .answer-table th {
      background-color: #4CAF50;
      color: white;
    }
  </style>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
</head>
<body>
  <div class="container">
    <h1>Tạo đề toán trắc nghiệm 1.3.1</h1>
    <label for="problemTemplate">Nhập mẫu bài toán:</label>
    <textarea id="problemTemplate" rows="10">
Cho phương trình !a#0!x^3 + !b:-5:5!x^2 + !c!x + !t! = 0. Tìm đạo hàm của phương trình.
A. {tinh: derivative('!a#0!*x^3 + !b:-5:5!*x^2 + !c!*x + !t!', 'x')}.
B. {tinh: !a!^3}.
C. {tinh: factorial(!b!)}.
D. {tinh: sin(!c!)}.

Lời giải: Đạo hàm của phương trình là ${tinh: derivative('!a#0!*x^3 + !b:-5:5!*x^2 + !c!*x + !t!', 'x')}$.
    </textarea>
    <label for="numQuestions">Số câu cần tạo:</label>
    <input type="number" id="numQuestions" min="1" max="50" value="5">
    <button id="generateBtn">Tạo đề</button>
    <button id="downloadBtn" style="display: none;">Tải đề</button>
    <div id="examArea"></div>
    <h2>Bảng đáp án</h2>
    <table class="answer-table" id="answerTable">
      <thead>
        <tr><th>Câu</th><th>Đáp án đúng</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <script>
    // Utility function to get a random integer within a range
    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Utility function to get a random non-zero integer within a range
    function getRandomNonZero(min, max) {
      let value;
      do {
        value = getRandomInt(min, max);
      } while (value === 0);
      return value;
    }

    // Utility function to shuffle an array (Fisher-Yates shuffle)
    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }

    // Utility function to escape special characters for use in RegExp
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
    }

    /**
     * Extracts base variable names (e.g., "a", "b") from !variable! placeholders in the template.
     * It avoids extracting from within {tinh:...} blocks.
     * Example: "!a#0! + !b:1:5!" -> ["a", "b"]
     */
    function extractVariables(template) {
        const varRegex = /!([a-zA-Z]\w*).*?!/g; // Matches !name...!, captures 'name'
        let match;
        const vars = new Set();
        // Remove {tinh:...} blocks temporarily to avoid extracting variables from them
        const templateWithoutCalc = template.replace(/{tinh:[^}]+}/g, '');
        while ((match = varRegex.exec(templateWithoutCalc)) !== null) {
            vars.add(match[1]); // Add the base variable name (e.g., 'a' from '!a#0!')
        }
        return Array.from(vars);
    }

    /**
     * Replaces !variable! placeholders in a string with their corresponding values from the variables object.
     * Example: template = "!a! + !b!", variables = {a: 5, b: 3} -> "5 + 3"
     */
    function replaceVariables(template, variables) {
        // Regex to find all forms of !variable! placeholders
        // It captures the base variable name like 'a' from '!a#0!' or '!a:1:5!' or '!a!'
        return template.replace(/!([a-zA-Z]\w*).*?!/g, (fullMatch, varName) => {
            return variables[varName] !== undefined ? variables[varName] : fullMatch;
        });
    }
    
    /**
     * Simplifies a mathematical expression string using math.js.
     * Returns the original expression if simplification fails.
     */
    function simplifyExpression(expr) {
      try {
        // Added basic pre-simplification for common cases like "2 + -3" -> "2 - 3"
        let preSimplifiedExpr = expr.replace(/\+\s*-\s*/g, '- ');
        preSimplifiedExpr = preSimplifiedExpr.replace(/-\s*-\s*/g, '+ ');
        return math.simplify(preSimplifiedExpr).toString();
      } catch (e) {
        // console.warn("Could not simplify expression:", expr, e);
        return expr; // Return original expression if simplification fails
      }
    }

    /**
     * Evaluates {tinh: expression} placeholders in a template string.
     * Assumes !var! placeholders *within* the expression have *already* been substituted by their numeric values
     * before this function is called (e.g. by a global replaceVariables pass).
     */
    function evaluateCalculations(templateWithNumbers, variables) { // `variables` might not be strictly needed here if all !var! are numbers
        const calcRegex = /{tinh:\s*([^}]+)}/g; // Matches {tinh: ...}
        return templateWithNumbers.replace(calcRegex, (match, exprFromTemplate) => {
            try {
                let finalExprToEvaluate = exprFromTemplate;

                // Special handling for derivative expressions
                if (exprFromTemplate.trim().startsWith("derivative")) {
                    const derivativeMatch = exprFromTemplate.match(/derivative\s*\(\s*'([^']*)'\s*,\s*'([^']*)'\s*\)/);
                    if (derivativeMatch) {
                        let functionString = derivativeMatch[1]; // e.g., '2*x^2 + 3' (already has numbers)
                        const variableOfDifferentiation = derivativeMatch[2]; // e.g., 'x'
                        
                        // The functionString should already have numbers from the global replaceVariables pass.
                        // An additional replaceVariables call here would be redundant but harmless.
                        // const actualFunctionString = replaceVariables(functionString, variables); 
                        
                        const derivativeResult = math.derivative(functionString, variableOfDifferentiation).toString();
                        return simplifyExpression(derivativeResult);
                    }
                }

                // For all other expressions, they should already have numbers.
                // The `variables` object in math.evaluate scope is for functions or pre-defined constants,
                // not for substituting !var! here.
                const result = math.evaluate(finalExprToEvaluate, {}); // Pass empty scope
                return simplifyExpression(result.toString());

            } catch (e) {
                // console.error("Error in evaluateCalculations for expr:", exprFromTemplate, e);
                return `[Lỗi tính toán: ${e.message}]`;
            }
        });
    }
    
   /**
     * Generates random values for variables.
     * Then, replaces all !variable! placeholders in the template with these numeric values.
     * Finally, beautifies the main equation part of this number-substituted template.
     */
    function lamdepbt(originalTemplate) {
        const varNames = extractVariables(originalTemplate);
        const generatedVariables = {};

        // Populate generatedVariables with random numbers based on !varName..._! syntax
        varNames.forEach(varName => {
            let minVal = -10, maxVal = 10; // Default range for !varName! and !varName#0!
            
            const rangeRegex = new RegExp(`!${escapeRegExp(varName)}:(-?\\d+):(-?\\d+)!`);
            const rangeMatch = originalTemplate.match(rangeRegex);
            
            const nonZeroRegex = new RegExp(`!${escapeRegExp(varName)}#0!`);
            const plainRegex = new RegExp(`!${escapeRegExp(varName)}!`); // Matches !varName!

            if (rangeMatch) {
                minVal = parseInt(rangeMatch[1]);
                maxVal = parseInt(rangeMatch[2]);
                generatedVariables[varName] = getRandomInt(minVal, maxVal);
            } else if (originalTemplate.match(nonZeroRegex)) {
                generatedVariables[varName] = getRandomNonZero(minVal, maxVal);
            } else if (originalTemplate.match(plainRegex)) { // Must be checked after more specific ones
                generatedVariables[varName] = getRandomInt(minVal, maxVal);
            } else {
                // Fallback or error if a varName was extracted but no pattern matched
                // This case should ideally not be reached if extractVariables is robust
                generatedVariables[varName] = getRandomInt(minVal, maxVal); 
            }
        });

        // Globally replace all !variable! placeholders with their generated numeric values first.
        let templateWithNumbers = replaceVariables(originalTemplate, generatedVariables);
        
        let finalProcessedTemplate = templateWithNumbers; // Start with the globally substituted template

        // Now, try to find and beautify the main equation part (which now contains numbers).
        const mainEquationMatch = templateWithNumbers.match(/^([^ABCD]*?=[^ABCD\n]*)/m);

        if (mainEquationMatch) {
            let equationPartWithNumbers = mainEquationMatch[0]; // e.g., "Cho phương trình 2x^3 + -3x = 0"
            let beautifiedEquation = equationPartWithNumbers;

            // Apply beautifications to the equation part that already has numbers
            // Handle "1x" -> "x", "1x^2" -> "x^2", but not "11x"
            beautifiedEquation = beautifiedEquation.replace(/\b1([a-zA-Z](?:\^[0-9]+)?\b)/g, '$1');
            beautifiedEquation = beautifiedEquation.replace(/\+\s*-\s*/g, '- '); // Example: "2 + -3" becomes "2 - 3"
            beautifiedEquation = beautifiedEquation.replace(/-\s*-\s*/g, '+ '); // Example: "2 - -3" becomes "2 + 3"
            
            // Attempt to simplify the LHS of the equation using math.js
            const eqParts = beautifiedEquation.split('=');
            if (eqParts.length === 2) {
                try {
                    const simplifiedLHS = simplifyExpression(eqParts[0].trim()); 
                    beautifiedEquation = simplifiedLHS + " = " + eqParts[1].trim();
                } catch (e) {
                    // console.warn("Could not simplify LHS of equation:", eqParts[0].trim(), e);
                    // If simplification fails, use the regex-beautified version
                }
            }
            
            // Replace the matched (and now beautified) equation part in `templateWithNumbers`
            finalProcessedTemplate = templateWithNumbers.replace(equationPartWithNumbers, beautifiedEquation);
        }
        
        return { template: finalProcessedTemplate, variables: generatedVariables };
    }


    /**
     * Creates a single question HTML structure with shuffled answers.
     */
    function createQuestion(index, rawTemplate) {
        // Step 1: Generate variables and get a template where all !var! are numbers and the main equation is beautified.
        const { template: processedTemplateWithNumbers, variables } = lamdepbt(rawTemplate);
        
        // Step 2: Evaluate all {tinh:...} blocks. These blocks might contain expressions
        // that were originally like '!a! + !b!', which are now '5 + 3' (if a=5,b=3)
        // after the global replace in lamdepbt.
        let questionStr = evaluateCalculations(processedTemplateWithNumbers, variables);
        
        const parts = questionStr.split(/\n\s*\n/); 
        const mainBlock = parts[0]; 
        const solutionPart = parts.slice(1).join('\n\n').replace(/^Lời giải:\s*/i, '').trim();

        const questionLines = mainBlock.split('\n');
        const questionContent = questionLines[0].trim();

        let originalCorrectAnswerValue = null;

        // Find the original correct answer (Option A from the rawTemplate)
        // This involves evaluating its {tinh:...} block using the *generatedVariables*
        const originalAOptionMatch = rawTemplate.match(/A\.\s*({tinh:[^}]+}|[^}\n]+)/);
        if (originalAOptionMatch) {
            let tempCorrectValueContainer = originalAOptionMatch[1]; // This is like "{tinh:!a!*2}" or "some text"
            // If it's a {tinh:...} block, evaluate it using the generated variables
            if (tempCorrectValueContainer.startsWith("{tinh:")) {
                // We need to evaluate this specific {tinh:...} block from rawTemplate
                // using the generatedVariables.
                // evaluateCalculations expects a full template string.
                // So, we pass only this {tinh:...} block.
                originalCorrectAnswerValue = evaluateCalculations(tempCorrectValueContainer, variables);
            } else {
                 // If it's plain text, it might still contain !var! that need substitution.
                originalCorrectAnswerValue = replaceVariables(tempCorrectValueContainer, variables);
            }
            originalCorrectAnswerValue = originalCorrectAnswerValue.trim();
        }

        let currentOptions = [];
        const optionRegex = /^\s*([A-D])\.\s*(.*)/;
        for (let i = 1; i < questionLines.length; i++) {
            const match = questionLines[i].match(optionRegex);
            if (match) {
                currentOptions.push(match[2].trim()); // These options are already evaluated from questionStr
            }
        }
        
        if (currentOptions.length !== 4 || originalCorrectAnswerValue === null) {
            console.error("Lỗi phân tích lựa chọn hoặc tìm đáp án gốc:", questionContent, "Giá trị A gốc:", originalCorrectAnswerValue, "Lựa chọn đã phân tích:", currentOptions);
            return { html: `<div class="question"><strong>Câu ${index}:</strong> Lỗi tạo câu hỏi. Vui lòng kiểm tra mẫu.</div>`, correct: 'Lỗi', solution: '' };
        }

        const shuffledAnswers = shuffleArray(currentOptions);
        const correctIndex = shuffledAnswers.findIndex(ans => ans === originalCorrectAnswerValue);
        const correctLetter = ['A', 'B', 'C', 'D'][correctIndex];

        if (!correctLetter) {
             console.error("Không tìm thấy đáp án đúng trong danh sách đã xáo trộn. Gốc:", originalCorrectAnswerValue, "Đã xáo trộn:", shuffledAnswers);
        }

        let formattedQuestion = `
          <div class="question">
            <div><strong>Câu ${index}:</strong><br>${questionContent}</div>
            A. ${shuffledAnswers[0]}<br>
            B. ${shuffledAnswers[1]}<br>
            C. ${shuffledAnswers[2]}<br>
            D. ${shuffledAnswers[3]}<br>`;
        if (solutionPart) {
            formattedQuestion += `<div class="solution"><strong>Lời giải:</strong> ${solutionPart}</div>`;
        }
        formattedQuestion += `</div>`;
        
        return { html: formattedQuestion, correct: correctLetter || 'N/A', solution: solutionPart };
    }

    document.getElementById('generateBtn').addEventListener('click', () => {
      const template = document.getElementById('problemTemplate').value;
      const num = parseInt(document.getElementById('numQuestions').value);
      const examArea = document.getElementById('examArea');
      const answerTableBody = document.getElementById('answerTable').getElementsByTagName('tbody')[0];
      
      examArea.innerHTML = '';
      answerTableBody.innerHTML = ''; 
      
      let questionsTextFileContent = '';
      let answersTextFileContent = 'Bảng đáp án:\nCâu | Đáp án\n----|--------\n';

      for (let i = 1; i <= num; i++) {
        let { html, correct, solution } = createQuestion(i, template);
        examArea.innerHTML += html;
        
        const newRow = answerTableBody.insertRow();
        newRow.insertCell().textContent = i;
        newRow.insertCell().textContent = correct;
        
        let plainTextQuestion = `Câu ${i}:\n${html.replace(/<strong>Lời giải:<\/strong>/gi, '\nLời giải:')
                                                  .replace(/<\/?[^>]+(>|$)/g, "") 
                                                  .replace(/^\s+/gm, '')          
                                                  .replace(/\n\s*\n/g, '\n')}\n\n`;
        questionsTextFileContent += plainTextQuestion;
        answersTextFileContent += `${i}\t| ${correct}\n`;
      }

      document.getElementById('downloadBtn').style.display = 'inline-block'; 
      document.getElementById('downloadBtn').onclick = () => {
        const fullText = `ĐỀ TRẮC NGHIỆM\n\n${questionsTextFileContent}\n\n${answersTextFileContent}`;
        const blob = new Blob([fullText], { type: "text/plain;charset=utf-8" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'de_toan_trac_nghiem.txt';
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
      };
      
      if (window.MathJax) {
        MathJax.typesetPromise([examArea, answerTableBody]).catch(function (err) {
          console.error('MathJax typeset error: ' + err.message);
        });
      }
    });
  </script>
</body>
</html>
